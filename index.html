<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Texas Crime</title>

  <!-- ArcGIS CSS -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css"/>
  <!-- ArcGIS JS API -->
  <script src="https://js.arcgis.com/4.21/"></script>

  <style>
    html, body, #viewDiv {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 10;
      width: 220px;
    }
    #optionsDiv {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 10;
    }
    #footer {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(255,255,255,0.8);
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      text-align: center;
    }
  </style>
</head>
<body>

<div id="controls">
  <h3>Texas Crime Change 2009-2019</h3>

  <label for="pageSelect">Open another map:</label>
  <select id="pageSelect" onchange="if(this.value) window.open(this.value,'_blank')">
    <option value="">Select a page</option>
    <option value="tile_layer.html">Tile Layer</option>
    <option value="simple_mapping.html">Simple Mapping</option>
    <option value="query_task.html">Query Task</option>
    <option value="on_event.html">On Event</option>
    <option value="dynamic_layers.html">Dynamic Layers</option>
    <option value="basemap_gallery.html">Basemap Gallery</option>
  </select>

  <hr>
  <h4>Toggle Layers</h4>
  <div id="layerToggles"></div>
</div>

<!-- Crime Query Panel -->
<div id="optionsDiv">
  <label for="attSelect">2019 Crime Data:</label>
  <select id="attSelect">
    <option value="ViolentPer1000">Violent Crime Per 1000 Population</option>
    <option value="ViolentInt">Total Violent Crime</option>
  </select>
  <br><br>

  <label for="signSelect">Operator:</label>
  <select id="signSelect">
    <option value=">">is greater than</option>
    <option value="<">is less than</option>
    <option value="=">is equal to</option>
  </select>
  <br><br>

  <label for="valSelect">Value:</label>
  <input type="number" id="valSelect" value="5">
  <br><br>

  <button id="doBtn">Run Query</button>
  <p id="printResults"></p>
</div>

<div id="viewDiv"></div>
<div id="footer">&copy; 2025 Parker Cook | Data source: ESRI Census Housing Year Built</div>

<script>
require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
  "esri/layers/GraphicsLayer",
  "esri/tasks/QueryTask",
  "esri/tasks/support/Query",
  "dojo/dom",
  "dojo/on",
  "dojo/_base/array"
], function(Map, MapView, FeatureLayer, GraphicsLayer, QueryTask, Query, dom, on, arrayUtils){

  const map = new Map({
    basemap: "streets-navigation-vector"
  });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [-98.5795, 39.8283],
    zoom: 4.5
  });

  const layersInfo = [
    {
      name: "State Boundary",
      url: "https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/9"
    },
    {
      name: "Texas Cities 2009",
      url: "https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/8"
    },
    {
      name: "Texas Cities 2019",
      url: "https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/7"
    },
    {
      name: "Cities Violent Per 1000 2009",
      url: "https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/2"
    },
    {
      name: "Cities Violent Per 1000 2019",
      url: "https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/1"
    }
  ];

  const layerObjects = [];

  /* ------------------------------
     CREATE ALL MAP LAYERS + POPUPS
  --------------------------------*/
  layersInfo.forEach((info, idx) => {

    let popupTemplate = null;

    if (info.name === "Texas Cities 2009" || info.name === "Texas Cities 2019") {
      popupTemplate = {
        title: "{NAME}",
        content: `
          <b>Population:</b> {Population}<br><br>

          <b>Violent Crime:</b> {ViolentCrime}<br>
          <b>Murder:</b> {Murder}<br>
          <b>Rape:</b> {Rape}<br>
          <b>Robbery:</b> {Robbery}<br>
          <b>Aggravated Assault:</b> {AggravatedAssault}<br>
          <b>Property Crime:</b> {PropertyCrime}<br><br>

          <b>Violent Crime Per 1000:</b> {ViolentPer1000}
        `
      };
    }

    const fl = new FeatureLayer({
      url: info.url,
      visible: true,
      id: "layer_" + idx,
      title: info.name,
      popupTemplate: popupTemplate
    });

    map.add(fl);
    layerObjects.push(fl);
  });

  /* ------------------------------------
     GENERATE LAYER TOGGLE CHECKBOXES
  --------------------------------------*/
  const layerToggleContainer = document.getElementById("layerToggles");

  layerObjects.forEach((layer, index) => {
    const div = document.createElement("div");

    div.innerHTML = `
      <label>
        <input type="checkbox" id="layerToggle_${index}" checked>
        ${layer.title}
      </label>
    `;

    layerToggleContainer.appendChild(div);

    document.getElementById(`layerToggle_${index}`)
      .addEventListener("change", (e) => {
        layer.visible = e.target.checked;
      });
  });

  /* -----------------------------
     CRIME QUERY SYSTEM (MERGED)
  ------------------------------*/

  // Use the 2019 crime layer for query
  const layerUrl = layersInfo[4].url;

  const resultsLayer = new GraphicsLayer();
  map.add(resultsLayer);

  const qTask = new QueryTask({ url: layerUrl });

  const qParams = new Query({
    returnGeometry: true,
    outFields: ["*"]
  });

  function doQuery(){
    resultsLayer.removeAll();

    const attribute = dom.byId("attSelect").value;
    const operator = dom.byId("signSelect").value;
    const value = dom.byId("valSelect").value;

    qParams.where = `${attribute} ${operator} ${value}`;

    qTask.execute(qParams).then(function(res){
      if(res.features.length === 0){
        dom.byId("printResults").innerHTML = "No results found!";
        return;
      }

      res.features.forEach(f => {
        f.popupTemplate = {
          title: "{NAME}",
          content: `{${attribute}}`
        };
      });

      resultsLayer.addMany(res.features);

      view.goTo(res.features).then(function(){
        view.popup.open({ features: res.features });
      });

      dom.byId("printResults").innerHTML = `${res.features.length} results found!`;
    })
    .catch(err => console.error("Query failed:", err));
  }

  on(dom.byId("doBtn"), "click", doQuery);

});
</script>

</body>
</html>
