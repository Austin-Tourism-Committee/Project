<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Texas Crime — Simplified Reverse Buffer</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css"/>
  <script src="https://js.arcgis.com/4.21/"></script>

  <style>
    html, body, #viewDiv { height:100%; margin:0; padding:0; font-family:Arial, Helvetica, sans-serif; }
    #controls { position:absolute; top:10px; left:10px; background:white; padding:10px; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,0.3); z-index:10; width:260px; }
    #layerToggles { margin-top:8px; max-height:220px; overflow:auto; }
    .panel { position:absolute; right:10px; background:white; padding:10px; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,0.3); z-index:10; width:240px; }
    #bufferPanel2009 { top:10px; }
    #bufferPanel2019 { top:200px; }
    .panel h4 { margin:0 0 6px 0; font-size:14px; }
    .panel label { font-size:12px; display:block; margin-top:6px; }
    .panel input { width:80px; }
    .panel button { margin-top:8px; width:100%; }
    #footer { position:absolute; bottom:5px; left:50%; transform:translateX(-50%); background-color: rgba(255,255,255,0.85); padding:5px 10px; border-radius:6px; font-size:12px; text-align:center; z-index:10; }
  </style>
</head>
<body>

<div id="controls">
  <h3>Texas Crime Change 2009-2019</h3>
  <hr>
  <h4>Toggle Layers</h4>
  <div id="layerToggles"></div>
</div>

<div id="bufferPanel2009" class="panel">
  <h4>2009 — Crime Buffer</h4>
  <label>ViolentPer1000 ≥ <input id="vp2009" type="number" value="5"></label>
  <label>Distance (miles): <input id="dist2009" type="number" value="25"></label>
  <button id="buffer2009Btn">Draw Buffers Around High-Crime Cities</button>
  <button id="clear2009Btn">Clear Buffers</button>
  <p id="print2009" style="font-size:12px;margin-top:6px"></p>
</div>

<div id="bufferPanel2019" class="panel">
  <h4>2019 — Crime Buffer</h4>
  <label>ViolentPer1000 ≥ <input id="vp2019" type="number" value="5"></label>
  <label>Distance (miles): <input id="dist2019" type="number" value="25"></label>
  <button id="buffer2019Btn">Draw Buffers Around High-Crime Cities</button>
  <button id="clear2019Btn">Clear Buffers</button>
  <p id="print2019" style="font-size:12px;margin-top:6px"></p>
</div>

<div id="viewDiv"></div>
<div id="footer">&copy; 2025 Parker Cook | Data: ESRI Census Housing Year Built & Texas Crime</div>

<script>
require([
  "esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer",
  "esri/layers/GraphicsLayer", "esri/Graphic", "esri/geometry/geometryEngine",
  "dojo/dom"
], function(Map, MapView, FeatureLayer, GraphicsLayer, Graphic, geometryEngine, dom){

  const map = new Map({ basemap: "streets-navigation-vector" });
  const view = new MapView({ container:"viewDiv", map:map, center:[-98.5795,31.5], zoom:6 });

  // ---------------------- Layers ----------------------
  const layersInfo = [
    { name:"State Boundary", url:"https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/9" },
    { name:"Texas Cities 2009", url:"https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/8" },
    { name:"Texas Cities 2019", url:"https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/7" },
    { name:"Cities Violent Per 1000 2009", url:"https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/2" },
    { name:"Cities Violent Per 1000 2019", url:"https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/1" }
  ];

  const layerObjects = [];
  layersInfo.forEach((info, idx) => {
    let popupTemplate = null;
    if(info.name.includes("Cities")){
      popupTemplate = { title:"{NAME}", content:`<b>Population:</b> {Population}<br><b>Violent Crime:</b> {ViolentCrime}<br><b>Violent Per 1000:</b> {ViolentPer1000}` };
    }
    const fl = new FeatureLayer({ url:info.url, visible:true, id:"layer_"+idx, title:info.name, popupTemplate:popupTemplate, outFields:["*"] });
    map.add(fl);
    layerObjects.push(fl);
  });

  // ---------------------- Layer Toggles ----------------------
  const layerToggleContainer = dom.byId("layerToggles");
  layerObjects.forEach((layer,index)=>{
    const div = document.createElement("div");
    div.innerHTML = `<label><input type="checkbox" id="layerToggle_${index}" checked> ${layer.title}</label>`;
    layerToggleContainer.appendChild(div);
    dom.byId(`layerToggle_${index}`).addEventListener("change", e => { layer.visible = e.target.checked; });
  });

  // ---------------------- Graphics Layers ----------------------
  const bufferLayer2009 = new GraphicsLayer({ id:"buffer2009" });
  const bufferLayer2019 = new GraphicsLayer({ id:"buffer2019" });
  map.addMany([bufferLayer2009, bufferLayer2019]);

  const city2009 = layerObjects.find(l=>l.title==="Texas Cities 2009");
  const city2019 = layerObjects.find(l=>l.title==="Texas Cities 2019");

  function setPrint(year,text){ dom.byId(year===2009?"print2009":"print2019").innerText=text; }

  // ---------------------- Simplified Buffer Function ----------------------
  function drawBuffer(year){
    let cityLayer, bufferLayer, threshold, distance, printTarget;
    if(year===2009){ cityLayer=city2009; bufferLayer=bufferLayer2009; threshold=Number(dom.byId("vp2009").value); distance=Number(dom.byId("dist2009").value); printTarget=2009; }
    else{ cityLayer=city2019; bufferLayer=bufferLayer2019; threshold=Number(dom.byId("vp2019").value); distance=Number(dom.byId("dist2019").value); printTarget=2019; }

    bufferLayer.removeAll(); setPrint(printTarget,"Drawing buffers...");

    const q = cityLayer.createQuery();
    q.where = `ViolentPer1000 >= ${threshold}`;
    q.returnGeometry = true;
    q.outFields = ["*"];

    cityLayer.queryFeatures(q).then(res=>{
      if(!res.features || res.features.length===0){ setPrint(printTarget,"No high-crime cities found."); return; }

      res.features.forEach(f=>{
        const buf = geometryEngine.geodesicBuffer(f.geometry, distance, "miles");
        bufferLayer.add(new Graphic({ geometry:buf, symbol:{ type:"simple-fill", color:[255,0,0,0.06], outline:{color:[255,0,0,0.8], width:2} } }));
      });

      setPrint(printTarget, `Buffers drawn around ${res.features.length} high-crime cities.`);
    }).catch(err=>{
      console.error(err);
      setPrint(printTarget,"Error querying high-crime cities.");
    });
  }

  // ---------------------- Button Hooks ----------------------
  dom.byId("buffer2009Btn").addEventListener("click",()=>drawBuffer(2009));
  dom.byId("buffer2019Btn").addEventListener("click",()=>drawBuffer(2019));
  dom.byId("clear2009Btn").addEventListener("click",()=>{ bufferLayer2009.removeAll(); setPrint(2009,"Cleared."); });
  dom.byId("clear2019Btn").addEventListener("click",()=>{ bufferLayer2019.removeAll(); setPrint(2019,"Cleared."); });

  view.on("click", function(event){
    view.hitTest(event).then(hit=>{
      const r = hit.results && hit.results.find(h=>h.graphic && h.graphic.layer && h.graphic.layer.type==="feature");
      if(r && r.graphic){ view.popup.open({ features:[r.graphic], location:event.mapPoint }); }
    });
  });

});
</script>

</body>
</html>
