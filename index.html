<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Texas Violent Crime Analysis</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css"/>
  <script src="https://js.arcgis.com/4.21/"></script>

  <!-- CSS Link with inline styles included -->
  <link rel="stylesheet" href="css/main_style.css" />

 </head>
<body>

  <!-- MAIN MAP APP (everything that belongs to the map/home view) -->
<div id="mainApp">
  <div id="controls">
    <h4>Select A Year</h4>
    <div id="layerToggles"></div>
  </div>

<div id="mainPanel">
  <!-- Buffer Panel -->
  <div id="bufferPanel2009">
    <h4>Crime Buffer</h4>
    <label>Violent Crimes (per 1000) ≥<input id="vp2009" type="number" value="5"></label><br>
    <label>Distance (miles): <input id="dist2009" type="number" value="25"></label><br>
    <br>
    <button id="buffer2009Btn">2009</button>
    <button id="clear2009Btn">Clear</button>
    <br><br>
    <button id="buffer2019Btn">2019</button>
    <button id="clear2019Btn">Clear</button>
    <br><br>
    <button id="fastBufferBtn">Fast Buffer</button>
    <button id="clearFastBufferBtn">Clear</button>
    <!-- <p id="print2009" style="font-size:12px;margin-top:6px"></p> -->
  </div>

  <!-- Query Panel -->
  <div id="queryPanel">
    <br><br>
    <h4>Crime Query</h4>
    <!-- Attribute selection dropdown -->
      <label>Attribute:</label>
      <select id="attSelect">
        <option value="ViolentPer1000">Violent Crime Per 1000</option>
        <option value="ViolentInt">Total Violent Crime</option>
      </select>
      <br><br>
      <!-- Logical operator selection -->
      <label>Operator:</label>
      <select id="signSelect">
        <option value=">">is greater than</option>
        <option value="<">is less than</option>
        <option value="=">is equal to</option>
      </select>
      <br><br>
      <!-- Number input box   -->
      <label>Value:</label>
      <input type="number" id="valSelect" value="5">
      <br><br>
      <!-- Query button -->
      <button id="queryBtn">Run Query</button>
      <button id="clearQueryResultBtn">Clear Result</button>
      <p id="printResults"></p>
  </div>
</div>

<!-- Map display div -->
<div id="viewDiv"></div>

<!-- Footer -->
<div id="footer">&copy; 2025 Collinsworth, Cook, Lucke, McDonald | Data source: ESRI, FBI Crime Database, TxDOT</div>

</div> <!-- end mainApp -->

<!-- RESOURCES PANEL (swaps with the map area) -->
<div id="resourcesPanel">
  <div class="resources-inner">
  <h2>Data Resources Utilized</h2>

  <!-- Data source listing -->
  <p class="resources-intro">
    The Following Datasets and Spatial References Were Utilized to Build the <br>
    Texas Crime 2009 & 2019 Map
  </p>

  <section class="resource-section">
    <h3>FBI Crime Data</h3>
    <ul class="resource-list">
      <li>
        <a href="https://ucr.fbi.gov/crime-in-the-u.s/2019/crime-in-the-u.s.-2019/tables/table-8/table-8-state-cuts/texas.xls" target="_blank" rel="noopener">
          Texas Crime 2019 – FBI UCR Table 8 (Texas)
        </a>
      </li>
      <li>
        <a href="https://ucr.fbi.gov/crime-in-the-u.s/2009" target="_blank" rel="noopener">
          Texas Crime 2009 – FBI Crime in the U.S. 2009
        </a>
      </li>
    </ul>
  </section>

  <section class="resource-section">
    <h3> Texas Boundary & Cities Layers</h3>
    <ul class="resource-list">
      <li>
        <a href="https://catalog.data.gov/dataset/tiger-line-shapefile-2017-state-texas-current-place-state-based" target="_blank" rel="noopener">
          Texas Cities – TIGER/Line Shapefile 2017, Current Places
        </a>
      </li>
      <li>
        <a href="https://gis-txdot.opendata.arcgis.com/datasets/TXDOT::texas-state-boundary/about" target="_blank" rel="noopener">
          Texas State Boundary – TxDOT Open Data
        </a>
      </li>
    </ul>
  </section>
  </div>
</div> <!-- end Resources -->

<!-- ABOUT US PANEL (swaps with the map area) -->
<div id="aboutPanel">
  <div class="about-inner">
    <h2>About The Team</h2>

<!-- Person card layout repeated for each team member -->
  <!-- Parker card -->
  <div class="about-person">
    <img src="images/Parker.jpg" alt="Parker Cook">
    <div class="about-text">
      <h4>Parker Cook</h4>
      <p>
        I am a GIS major and Sustainability Studies minor.
        My research interests are solar and wind energy, remote sensing, and resource management.
        Outside of school I enjoy cooking and hiking.
      </p>
    </div>
  </div>

  <!-- Marissa card -->
  <div class="about-person">
    <img src="images/Marissa.jpg" alt="Marissa Lucke">
    <div class="about-text">
      <h4>Marissa Lucke</h4>
      <p>
        I am a GIS major and Data Analytics minor.
        My research interests are planetary mapping, remote sensing, and geospatial programming.
        Outside of school I enjoying spending time cooking, baking, and taking my two dogs on long walks.
      </p>
    </div>
  </div>

  <!-- Kai card -->
  <div class="about-person">
    <img src="images/Kai.jpg" alt="Kai McDonald">
    <div class="about-text">
      <h4>Kai McDonald</h4>
      <p>
        I am a GIS major and Data Analytics minor.
        My research interests are remote sensing, civil engineering, and wildlife conservation.
        Outside of school I enjoy bird watching and hiking.
      </p>
    </div>
  </div>

  <!-- Seth card -->
  <div class="about-person">
    <img src="images/Seth.jpg" alt="Seth Collinsworth">
    <div class="about-text">
      <h4>Seth Collinsworth</h4>
      <p>
        I am a GIS major and Art History minor.
        My research interests are remote sensing, business, and political science.
        Outside of school I enjoying spending time reading.
      </p>
    </div>
  </div>
</div> <!-- end About Us Panel -->

<script>

// REQUIRE MODULES FROM THE ESRI API
// This loads all ArcGIS modules we need: Map, MapView, FeatureLayer,
// geometry tools, etc.
// Once loaded, the callback function below runs.
require([
  "esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer",
  "esri/layers/GraphicsLayer", "esri/Graphic", "esri/geometry/geometryEngine",
  "esri/tasks/QueryTask", "esri/tasks/support/Query",
  "dojo/dom", "esri/widgets/Legend", "esri/widgets/Home"
], function(
  Map, MapView, FeatureLayer, GraphicsLayer, Graphic, geometryEngine,
  QueryTask, Query, dom, Legend, Home,
){

  // CREATE THE MAIN MAP
  const map = new Map({
  basemap: "osm"
});

 // CREATE THE MAP VIEW (controls how the map appears on screen)
  const view = new MapView({
    container: "viewDiv", // ID of the div where map will display
    map: map,             // Link the map
    center: [-98.5795, 31.5], // Center on Texas
    zoom: 6               // Zoomed out enough to see the full state
  });

  // Home widget resets the map back to the original starting position
const homeWidget = new Home({
  view: view
});

  /* LAYER SETUP */
  // layersInfo holds all the URLs and names of layers you want to load.
  // This makes it easier to add/remove layers without editing lots of code.
  const layersInfo = [
    { name:"State Boundary", url:"https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/9" },
    { name:"Texas Cities 2009", url:"https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/8" },
    { name:"Texas Cities 2019", url:"https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/7" },
    { name:"Violent Crime (Per 1000): 2009", url:"https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/2" },
    { name:"Violent Crime (Per 1000): 2019", url:"https://services1.arcgis.com/M68M8H7oABBFs1Pf/arcgis/rest/services/Texas_Crime_Change_2009_2019_WFL1/FeatureServer/1" }
  ];

  const layerObjects = [];

  layersInfo.forEach((info, idx) => {
    let popupTemplate = null;
    if (info.name.includes("Cities")) {
      popupTemplate = {
        title: "{NAME}",
        content: `
          <b>Population:</b> {Population}<br><br>
          <b>Violent Crime:</b> {ViolentCrime}<br>
          <b>Murder:</b> {Murder}<br>
          <b>Rape:</b> {Rape}<br>
          <b>Robbery:</b> {Robbery}<br>
          <b>Aggravated Assault:</b> {AggravatedAssault}<br>
          <b>Property Crime:</b> {PropertyCrime}<br><br>
          <b>Violent Crime Per 1000:</b> {ViolentPer1000}
        `
      };
    }

    // Create the FeatureLayer
    const fl = new FeatureLayer({
      url: info.url,
      visible: true,
      id: "layer_" + idx,
      title: info.name,
      popupTemplate: popupTemplate,
      outFields: ["*"]
    });

    // Add layer to map
    map.add(fl);
    layerObjects.push(fl);
  });

  // --- Texas extent on load ---
  view.when(function () {
    const stateLayer = layerObjects[0]; // "State Boundary" layer
    if (!stateLayer) return;

    stateLayer.when().then(function () {
      view.goTo(stateLayer.fullExtent.expand(0.8));
    });
  });

  /* TOGGLE SWITCH */
  // Creates radio boxes to switch between 2009 and 2019
  layerObjects[4].visible = false; // 2019 layer off by default
  const toggleDiv = dom.byId("layerToggles");
  const row = document.createElement("div"); //create div
  //Create radio boxes
  row.innerHTML = `<input id="layerToggle_2009" type="radio" name="dateSwitchTest" checked><label for="layerToggle_2009">2009</label><input id="layerToggle_2019" type="radio" name="dateSwitchTest"><label for="layerToggle_2019">2019</label>`;
  toggleDiv.appendChild(row);
  //Changes when clicked
  document.getElementById(`layerToggle_2009`).addEventListener("change", e => {
    layerObjects[3].visible = e.target.checked; //Turn 2009 layer on
    layerObjects[4].visible = !e.target.checked; //Turn 2019 layer off
  });
  document.getElementById(`layerToggle_2019`).addEventListener("change", e => {
    layerObjects[4].visible = e.target.checked; //Turn 2019 layer on
    layerObjects[3].visible = !e.target.checked; //Turn 2009 layer off
  });

  /* BUFFER LAYERS */
  const bufferLayer2009 = new GraphicsLayer();
  const bufferLayer2019 = new GraphicsLayer();
  const fastBufferLayer = new GraphicsLayer();
  map.addMany([bufferLayer2009, bufferLayer2019, fastBufferLayer]);

  const city2009 = layerObjects.find(l=>l.title==="Texas Cities 2009");
  const city2019 = layerObjects.find(l=>l.title==="Texas Cities 2019");

  // setPrint FUNCTION
  // Input: year, text
  // Output: text to
  // function setPrint(year,text){
  //   dom.byId(year===2009 ? "print2009" : "print2019").innerText = text;
  // }

  // ---------------- BUFFER ----------------
  // BUFFER FUNCTION
  // Creates Buffer Features around cities above a crime threshold. Based on city2009 layer.
  // Input: year
  // Output:
  function drawBuffer(year){
    let cityLayer, bufferLayer, threshold, distance, printTarget;
    threshold = Number(dom.byId("vp2009").value);
    distance = Number(dom.byId("dist2009").value);

    // Determine which layer and text panel to use
    if(year===2009){
      cityLayer = city2009; bufferLayer = bufferLayer2009;
      // printTarget = 2009;
    } else {
      cityLayer = city2019; bufferLayer = bufferLayer2019;
      // printTarget = 2019;
    }

    // Clear old buffers
    bufferLayer.removeAll();
    // setPrint(printTarget, "Drawing buffers...");

    // Build query to find matching cities
    const q = cityLayer.createQuery();
    q.where = `ViolentPer1000 >= ${threshold}`;
    q.returnGeometry = true;
    q.outFields = ["*"];

    // Run the query
    cityLayer.queryFeatures(q).then(res => {
      if(!res.features.length){
        // setPrint(printTarget, "No high-crime cities found.");
        return;
      }

      // For each city found, draw a buffer polygon
      res.features.forEach(f=>{
        const buf = geometryEngine.geodesicBuffer(f.geometry, distance, "miles");
        bufferLayer.add(new Graphic({
          geometry: buf,
          symbol: {
            type: "simple-fill",
            color: [255,0,0,0.06],
            outline: { color:[255,0,0,0.8], width:2 }
          }
        }));
      });

      // setPrint(printTarget, `Buffers drawn around ${res.features.length} cities.`);
    });
  }

  // FAST BUFFER FUNCTION
  // Creates 5 Buffer Features. Based on city2009 layer.
  // Input:
  // Output:
  function drawFastBuffer() {
    fastBufferLayer.removeAll();
    dom.byId("fastBufferText").innerText = "Running Fast Query";

    const q = city2009.createQuery();
    q.where = "1=1";
    q.returnGeometry = true;
    q.outFields = ["*"];
    q.num = 5;

    city2009.queryFeatures(q).then(res => {
      if(!res.features.length){
        dom.byId("fastBufferText").innerText = "No Features Found";
        return;
      }

      res.features.forEach(f=>{
        const buf = geometryEngine.geodesicBuffer(f.geometry, 25, "miles");
        fastBufferLayer.add(new Graphic({
          geometry: buf,
          symbol: {
            type:"simple-fill",
            color:[0,0,255,0.06],
            outline:{color:[0,0,255,0.8], width:2}
          }
        }));
      });

      dom.byId("fastBufferText").innerText = "Fast Buffer Complete";
    });
  }

  // ---------------- ATTRIBUTE QUERY ----------------
  const layerUrl = layersInfo[4].url; // Cities Violent Per 1000 2019
  const resultsLayer = new GraphicsLayer();
  map.add(resultsLayer);

  const qTask = new QueryTask({ url: layerUrl });

  const qParams = new Query({
    returnGeometry: true,
    outFields: ["*"]
  });

  // ATTRIBUTE QUERY RUN FUNCTION
  // Runs attribute-based querying on 2019 violent crime layer.
  // Input:
  // Output:
  function doQuery(){
    resultsLayer.removeAll();

    const attribute = dom.byId("attSelect").value;
    const operator = dom.byId("signSelect").value;
    const value = dom.byId("valSelect").value;

    // Build SQL WHERE statement
    qParams.where = `${attribute} ${operator} ${value}`;

    // Execute query
    qTask.execute(qParams).then(function(res){
      // Fail check
      if(res.features.length === 0){
        dom.byId("printResults").innerHTML = "No Results Found";
        return;
      }

      // Set popup for each result feature
      res.features.forEach(f => {
        f.popupTemplate = {
          title: "{NAME}",
          content: `<b>${attribute}:</b> {${attribute}}`
        };
      });

      // Add results to map
      resultsLayer.addMany(res.features);

      // Zoom to results and open popup
      view.goTo(res.features).then(function(){
        view.popup.open({ features: res.features });
      });

      dom.byId("printResults").innerHTML = `${res.features.length} Results Found`;
    })
    .catch(err => console.error("Query Failed:", err));
  }

  // ---------------- EVENT LISTENERS ----------------
  // BUFFER BUTTON EVENT LISTENERS
  // Draw Buffer Buttons
  // 2009 Draw Buffer Button
  dom.byId("buffer2009Btn").addEventListener("click", ()=>drawBuffer(2009));
  // 2019 Draw Buffer Button
  dom.byId("buffer2019Btn").addEventListener("click", ()=>drawBuffer(2019));
  // Fast Draw Buffer Button
  dom.byId("fastBufferBtn").addEventListener("click", drawFastBuffer);

  // Remove Buffer Buttons
  // 2009 Remove Buffer Button
  dom.byId("clear2009Btn").addEventListener("click", ()=>{
    bufferLayer2009.removeAll();
    // setPrint(2009,"Buffers Cleared");
  });
  // 2019 Remove Buffer Button
  dom.byId("clear2019Btn").addEventListener("click", ()=>{
    bufferLayer2019.removeAll();
    // setPrint(2019,"Buffers Cleared");
  });
  // Remove Fast Buffer Button
  dom.byId("clearFastBufferBtn").addEventListener("click", ()=>{
    fastBufferLayer.removeAll();
    // dom.byId("fastBufferText").innerText = "Fast Buffers Cleared";
  });

  // QUERY BUTTON EVENT LISTENERS
  // Run Query Button
  dom.byId("queryBtn").addEventListener("click", doQuery);
  // Remove Query Button
  dom.byId("clearQueryResultBtn").addEventListener("click", ()=>{
    resultsLayer.removeAll();
    // dom.byId("fastBufferText").innerText = "Query Results Cleared";
  });


  // ---------------- LEGEND SETUP ----------------
  // Disable 'State Boudary' layer in legend
  layerObjects[0].legendEnabled = false;
  // Disable 'Texas Cities 2009' layer in legend
  layerObjects[1].legendEnabled = false;
  // Disable 'Texas Cities 2019' layer in legend
  layerObjects[2].legendEnabled = false;
  // Create legend
  let legend = new Legend({
    view: view,
  });

  // ---------------- HOME WIDGET SETUP ----------------
  // Create home Button
  const home = new Home({
    view: view
  });

  // ------------- UI ELEMENTS ARRANGEMENT --------------
// Add legend in bottom left
view.ui.add(legend, "bottom-left");
// Move zoom button bottom left
view.ui.move("zoom", "bottom-left");
// Add Home button just next to zoom
view.ui.add(home, "bottom-left");

});
</script>

<!-- External JS file that handles UI styling / show-hide panels, etc. -->
<script src="javascript/style_UI.js"></script>

</body>
</html>
